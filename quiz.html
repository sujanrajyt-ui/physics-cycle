<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Multi-Subject Quiz + Answer Key</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --accent:#2563eb; --accent-2:#1d4ed8; --ok:#059669; --bad:#dc2626; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text);}
    .container{max-width:1150px; margin:24px auto; padding:0 16px;}
    header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px;}
    .brand{display:flex;align-items:center;gap:10px;}
    .badge{background:#eef2ff;color:#1e293b;border:1px solid #c7d2fe;border-radius:999px;padding:4px 10px;font-size:12px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;}
    .controls{display:grid;grid-template-columns:1fr 1fr 1fr auto; gap:10px; align-items:end;}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px;}
    select,button,input{border:1px solid var(--border);border-radius:8px;padding:10px 12px;font-size:14px;background:#fff;}
    button{background:var(--accent);color:white;border-color:var(--accent-2);cursor:pointer;}
    button.secondary{background:#f1f5f9;color:#0f172a;border-color:var(--border);}
    button.ghost{background:#fff;color:var(--accent);border-color:var(--accent-2);}
    button:disabled{opacity:.6;cursor:not-allowed}
    .setup{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:10px;}
    .setup .chip{display:flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff;font-size:13px;color:#0f172a;}
    .setup .chip input[type="checkbox"]{transform:scale(1.1);}
    .setup .field{display:flex;align-items:center;gap:6px;}
    .panel{margin-top:14px; display:none;}
    .panel.active{display:block;}
    .muted{color:var(--muted); font-size:13px;}
    .grid{display:grid;grid-template-columns:300px 1fr; gap:12px;align-items:start;}
    .sidebar{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;max-height:70vh;overflow:auto;}
    .side-section{margin-bottom:12px;}
    .side-title{font-weight:700;margin-bottom:6px;}
    .unit{padding:8px;border-radius:8px;cursor:pointer;}
    .unit:hover{background:#f8fafc;}
    .unit.active{background:#eef2ff;border:1px solid #c7d2fe;}
    .small{font-size:12px;color:var(--muted);}

    /* Quiz panel */
    .meta{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;margin-bottom:10px;}
    .qbox{padding:12px;border:1px dashed var(--border);border-radius:10px;margin-bottom:10px;background:#fcfcff;}
    .qtext{font-weight:600;margin-bottom:8px;}
    ol.opts{margin:0; padding-left:22px;}
    ol.opts li{margin:6px 0; padding:8px 10px;border:1px solid var(--border);border-radius:8px;cursor:pointer;background:#fff;}
    ol.opts li:hover{border-color:#cbd5e1; background:#f8fafc;}
    ol.opts li.correct{border-color:#86efac;background:#ecfdf5;}
    ol.opts li.wrong{border-color:#fecaca;background:#fef2f2;}
    .trick{font-size:13px;color:#0f172a;background:#f8fafc;border:1px solid var(--border);border-radius:8px;padding:8px;margin-top:10px;white-space:pre-wrap;}
    .nav{display:flex;gap:8px;justify-content:space-between;margin-top:12px;}
    .progress{height:8px;background:#e2e8f0;border-radius:6px;overflow:hidden;margin:8px 0 0;}
    .bar{height:100%;background:#2563eb;width:0%;}

    /* Answer Key panel */
    #keyPanel .qitem{border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:10px;background:#fff;}
    #keyPanel .qitem h4{margin:0 0 8px 0;font-size:14px;}
    #keyPanel .actions{display:flex;gap:8px;justify-content:flex-end;margin-bottom:8px;}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <h2 style="margin:0;">Multi-Subject Quiz + Answer Key</h2>
        <span class="badge" id="summaryBadge">Loading…</span>
      </div>
      <div class="muted">Pick Subject & Unit. Default view shows Answer Key (correct answers in green). Switch to Quiz to practice/test.</div>
    </header>

    <div class="card">
      <div class="controls">
        <div>
          <label for="subjectSelect">Subject</label>
          <select id="subjectSelect"><option value="__all__">All Subjects</option></select>
        </div>
        <div>
          <label for="unitSelect">Unit</label>
          <select id="unitSelect"><option value="__all__">All Units</option></select>
        </div>
        <div>
          <label for="viewSelect">View</label>
          <select id="viewSelect">
            <option value="answers">Answer Key</option>
            <option value="quiz">Quiz</option>
          </select>
        </div>
        <div>
          <button id="startBtn">Start Quiz</button>
        </div>
      </div>

      <!-- Setup row (applies to both Answer Key and Quiz) -->
      <div class="setup">
        <div class="field">
          <label for="countInput" class="muted">Question count</label>
          <input id="countInput" type="number" min="1" placeholder="All" style="width:120px;">
        </div>
        <label class="chip"><input type="checkbox" id="shuffleQuestions" checked> Shuffle questions</label>
        <label class="chip"><input type="checkbox" id="shuffleOptions" checked> Shuffle options</label>

        <!-- Quiz-only controls -->
        <div class="field" id="quizModeWrap">
          <label for="modeSelect" class="muted">Quiz mode</label>
          <select id="modeSelect">
            <option value="practice">Practice (instant feedback)</option>
            <option value="test">Test (scored)</option>
          </select>
        </div>

        <!-- Answer Key actions -->
        <button id="printKeyBtn" class="secondary">Print Key</button>
      </div>

      <!-- Answer Key Panel -->
      <div class="panel" id="keyPanel">
        <div id="keyHeader" class="muted" style="margin-bottom:8px;"></div>
        <div id="keyList"></div>
      </div>

      <!-- Quiz Panel -->
      <div class="panel" id="quizPanel">
        <div class="meta">
          <div>
            <span class="badge" id="subjectBadge">Subject</span>
            <span class="badge" id="unitBadge">Unit</span>
            <span class="muted" id="qCounter">Q 0/0</span>
          </div>
          <div style="min-width:160px;">
            <div class="progress"><div class="bar" id="progressBar"></div></div>
          </div>
        </div>

        <div class="qbox">
          <div class="qtext" id="qText">Question text</div>
          <ol class="opts" id="qOpts"></ol>
          <div class="trick" id="qTrick" style="display:none;"></div>
        </div>

        <div class="nav">
          <div>
            <button class="secondary" id="prevBtn">Prev</button>
            <button class="secondary" id="nextBtn">Next</button>
          </div>
          <div>
            <button class="secondary" id="endBtn" style="display:none;">End Test</button>
          </div>
        </div>
      </div>

      <!-- Result Panel -->
      <div class="panel" id="resultPanel">
        <div class="score" id="scoreLine">Score: 0/0</div>
        <div class="muted" id="resultNote">Great job! Try another subject or unit.</div>
        <div>
          <button id="restartBtn">Restart</button>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:12px;">
      <div class="sidebar">
        <div class="side-section">
          <div class="side-title">Subjects</div>
          <div id="subjectList"></div>
        </div>
        <div class="side-section">
          <div class="side-title" id="sideUnitsTitle">Units (selected subject)</div>
          <div id="unitList"></div>
        </div>
      </div>
      <div class="card">
        <div class="muted">Tip: Default view is Answer Key (green highlights). To practice, set View = Quiz and click Start Quiz.</div>
      </div>
    </div>
  </div>

  <!-- Ensure quizData exists BEFORE subject files load -->
  <script>window.quizData = window.quizData || {};</script>

  <!-- Include your subject JS files -->
  <script src="psp.js" defer></script>
  <script src="physics.js" defer></script>
  <script src="calculus.js" defer></script>
  <script src="basicelectronics.js" defer></script>
  <script src="uhv.js" defer></script>

  <!-- App: registry + trick generator (unchanged) + Answer Key-first UX -->
  <script defer>
    // --- Registry API ---
    window.quizSubjects = window.quizSubjects || {};
    function registerSubject(id, raw) {
      const subjectId = String(id).trim();
      const subjectName = (raw && raw.name) ? raw.name : subjectId;
      let units = [];
      if (raw && Array.isArray(raw.units)) {
        units = raw.units.map(u => ({
          id: u.id || u.name || 'Unit-' + Math.random().toString(36).slice(2,7),
          name: u.name || u.id,
          questions: Array.isArray(u.questions) ? u.questions : []
        }));
      } else if (raw && typeof raw === 'object') {
        units = Object.entries(raw).map(([unitName, qs]) => ({
          id: unitName,
          name: unitName,
          questions: Array.isArray(qs) ? qs : []
        }));
      } else {
        return;
      }
      addTricksToUnits(units, subjectId);
      window.quizSubjects[subjectId] = {
        id: subjectId,
        name: subjectName,
        units,
        totalQuestions: units.reduce((n,u)=>n+(u.questions?.length||0),0)
      };
      document.dispatchEvent(new CustomEvent('subject-registered', {
        detail: { id: subjectId, name: subjectName, count: window.quizSubjects[subjectId].totalQuestions }
      }));
    }

    // --- Auto-register from quizData (your files use quizData.SUBJECT) ---
    function autoRegisterFromQuizData() {
      const qd = window.quizData || {};
      const skip = new Set(['UHVUnits','units','categories','subjects','allQuestions','totalQuestions']);
      Object.keys(qd).forEach(key => {
        if (skip.has(key)) return;
        const raw = qd[key];
        if (raw && typeof raw === 'object' && !Array.isArray(raw)) {
          registerSubject(key, raw);
        }
      });
    }

    // --- Trick Generator (kept concise) ---
    function addTricksToUnits(units, subjectId) {
      const norm = (s) => String(s||"").toLowerCase().replace(/[’'"]/g,"").replace(/‑|–|—/g,"-").replace(/\s+/g," ").trim();
      const gen = [{ key:/all of these|both .* (a|b)/, tip:"If all options fit, choose 'All of these'." }];

      function scan(list, s){ for(const r of list) if(r.key.test(s)) return r.tip; return null; }

      const subject = (subjectId||'').toLowerCase();
      units.forEach(u => (u.questions||[]).forEach(q => {
        const a = q.options?.[q.correctIndex] || '';
        let tip = scan(gen, a.toLowerCase());
        if (!tip) {
          if (subject.includes('psp')) {
            if (/assembler|assembly.*machine/.test(q.text.toLowerCase())) tip="Assembler converts Assembly→Machine.";
            else if (/printf|formatted output/.test(q.text.toLowerCase())) tip="printf = formatted output; scanf = input.";
            else if (/switch.*case.*float/.test(q.text.toLowerCase())) tip="switch labels must be integral constants.";
          } else if (subject.includes('physics')) {
            if (/de broglie|λ\s*=/.test(q.text.toLowerCase())) tip="de Broglie: λ = h/p.";
            else if (/uncertainty|heisenberg/.test(q.text.toLowerCase())) tip="Δx·Δp ≥ ħ/2.";
          } else if (subject.includes('calculus')) {
            if (/maclaurin.*e\^x/.test(q.text.toLowerCase())) tip="e^x = 1 + x + x²/2! + ...";
            else if (/laplace|wave|heat/.test(q.text.toLowerCase())) tip="Wave=hyperbolic; Laplace=elliptic; Heat=parabolic.";
          } else if (subject.includes('basic electronics')) {
            if (/zener/.test(q.text.toLowerCase())) tip="Zener in breakdown ≈ constant voltage.";
            else if (/non-?inverting.*gain/.test(q.text.toLowerCase())) tip="Gain = 1 + Rf/R1.";
          } else if (subject.includes('uhv')) {
            if (/invariant.*universal/.test(q.text.toLowerCase())) tip="Invariant + universal → Natural Acceptance.";
            else if (/identify the correct order/.test(q.text.toLowerCase())) tip="URP: Understanding → Relationship → Physical.";
          }
        }
        q.trick = q.trick || tip || "Use core definitions and always-true properties.";
      }));
    }

    // ===== App Logic (Answer Key-first) =====
    (function () {
      const els = {
        subjectSelect: document.getElementById('subjectSelect'),
        unitSelect: document.getElementById('unitSelect'),
        viewSelect: document.getElementById('viewSelect'),
        modeSelect: document.getElementById('modeSelect'),
        countInput: document.getElementById('countInput'),
        shuffleQuestions: document.getElementById('shuffleQuestions'),
        shuffleOptions: document.getElementById('shuffleOptions'),
        printKeyBtn: document.getElementById('printKeyBtn'),
        startBtn: document.getElementById('startBtn'),

        keyPanel: document.getElementById('keyPanel'),
        keyList: document.getElementById('keyList'),
        keyHeader: document.getElementById('keyHeader'),

        quizPanel: document.getElementById('quizPanel'),
        resultPanel: document.getElementById('resultPanel'),

        qText: document.getElementById('qText'),
        qOpts: document.getElementById('qOpts'),
        qTrick: document.getElementById('qTrick'),
        qCounter: document.getElementById('qCounter'),
        progressBar: document.getElementById('progressBar'),
        subjectBadge: document.getElementById('subjectBadge'),
        unitBadge: document.getElementById('unitBadge'),
        prevBtn: document.getElementById('prevBtn'),
        nextBtn: document.getElementById('nextBtn'),
        endBtn: document.getElementById('endBtn'),
        scoreLine: document.getElementById('scoreLine'),
        restartBtn: document.getElementById('restartBtn'),

        summaryBadge: document.getElementById('summaryBadge'),
        subjectList: document.getElementById('subjectList'),
        unitList: document.getElementById('unitList'),
        sideUnitsTitle: document.getElementById('sideUnitsTitle'),
        quizModeWrap: document.getElementById('quizModeWrap')
      };

      const state = {
        subjects: {}, subjectOrder: [],
        currentSubjectId: '__all__', currentUnitId: '__all__',
        basePool: [], pool: [],
        index: 0, answered: new Map(), score: 0, total: 0,
        view: 'answers', mode: 'practice',
        settings: { count: null, shuffleQuestions: true, shuffleOptions: true }
      };

      // Utils
      function shuffle(arr) { const a=arr.slice(); for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }
      function cloneQuestion(q){ return { text:q.text, options:q.options.slice(), correctIndex:q.correctIndex, trick:q.trick }; }
      function prepareQuestion(q, shuffleOpts) {
        const copy = cloneQuestion(q);
        if (!shuffleOpts) return copy;
        const order = shuffle(copy.options.map((_,i)=>i));
        copy.options = order.map(i => copy.options[i]);
        copy.correctIndex = order.indexOf(copy.correctIndex);
        return copy;
      }
      function show(panel){ els.keyPanel.classList.toggle('active', panel==='key'); els.quizPanel.classList.toggle('active', panel==='quiz'); els.resultPanel.classList.toggle('active', panel==='result'); }

      // Build sidebar + selects
      function updateSummary() {
        const subs = Object.values(state.subjects);
        const unitsCount = subs.reduce((n,s)=>n+s.units.length,0);
        const totalQs = subs.reduce((n,s)=>n+s.units.reduce((m,u)=>m+(u.questions?.length||0),0),0);
        els.summaryBadge.textContent = `${subs.length} subjects • ${unitsCount} units • ${totalQs} questions`;

        // Subjects in sidebar
        els.subjectList.innerHTML = '';
        state.subjectOrder.forEach(id => {
          const s = state.subjects[id];
          const div = document.createElement('div');
          div.className = 'unit' + (id===state.currentSubjectId ? ' active':'');
          div.innerHTML = `<strong>${s.name}</strong><div class="small">${s.units.length} units • ${s.totalQuestions} Qs</div>`;
          div.addEventListener('click', () => {
            els.subjectSelect.value = id; onSubjectChange();
          });
          els.subjectList.appendChild(div);
        });
        renderSidebarUnits();
      }
      function renderSidebarUnits() {
        const id = state.currentSubjectId;
        els.sideUnitsTitle.textContent = id==='__all__' ? 'Units (all subjects)' : `Units (${state.subjects[id]?.name})`;
        els.unitList.innerHTML = '';

        if (id==='__all__') {
          state.subjectOrder.forEach(sid => {
            const s = state.subjects[sid];
            const h = document.createElement('div');
            h.className = 'small'; h.style.margin='8px 0 4px'; h.textContent = s.name;
            els.unitList.appendChild(h);
            s.units.forEach(u => {
              const div = document.createElement('div');
              div.className = 'unit'; div.innerHTML = `${u.name} <span class="small">• ${u.questions.length} Qs</span>`;
              div.addEventListener('click', () => { els.subjectSelect.value = sid; onSubjectChange(); els.unitSelect.value = u.id; onUnitChange(); });
              els.unitList.appendChild(div);
            });
          });
        } else {
          const s = state.subjects[id];
          s.units.forEach(u => {
            const div = document.createElement('div');
            div.className = 'unit'; div.innerHTML = `${u.name} <span class="small">• ${u.questions.length} Qs</span>`;
            div.addEventListener('click', () => { els.unitSelect.value = u.id; onUnitChange(); });
            els.unitList.appendChild(div);
          });
        }
      }
      function populateSubjectSelect() {
        const sel = els.subjectSelect;
        sel.innerHTML = '<option value="__all__">All Subjects</option>';
        state.subjectOrder.forEach(id => {
          const s = state.subjects[id]; const opt = document.createElement('option');
          opt.value = id; opt.textContent = s.name; sel.appendChild(opt);
        });
      }
      function populateUnitSelect() {
        const subId = els.subjectSelect.value;
        state.currentSubjectId = subId;
        const sel = els.unitSelect;
        sel.innerHTML = '<option value="__all__">All Units</option>';

        if (subId !== '__all__') {
          const s = state.subjects[subId];
          s.units.forEach(u => {
            const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.name;
            sel.appendChild(opt);
          });
        }
      }

      // Build pools
      function buildBasePool() {
        const subId = state.currentSubjectId;
        const unitId = state.currentUnitId;
        let pool = [];
        if (subId === '__all__') {
          Object.values(state.subjects).forEach(s => s.units.forEach(u => pool.push(...(u.questions||[]))));
        } else {
          const s = state.subjects[subId]; if (!s) { state.basePool=[]; return; }
          if (unitId === '__all__') s.units.forEach(u => pool.push(...(u.questions||[])));
          else {
            const u = s.units.find(x => x.id===unitId); pool = [...(u?.questions||[])];
          }
        }
        state.basePool = pool;
      }
      function applySettingsAndPreparePool() {
        let list = state.basePool.slice();
        if (state.settings.shuffleQuestions) list = shuffle(list);
        let count = els.countInput.value || null;
        if (state.view === 'quiz' && state.mode === 'test' && (count==null || count==='')) {
          count = Math.min(20, list.length);
        }
        if (count && Number(count)>0) list = list.slice(0, Math.min(Number(count), list.length));
        state.pool = list.map(q => prepareQuestion(q, state.settings.shuffleOptions));
        state.total = state.pool.length; state.index=0; state.answered.clear(); state.score=0;
      }

      // Answer Key
      function buildAnswerKey() {
        buildBasePool(); applySettingsAndPreparePool();
        const sName = state.currentSubjectId==='__all__' ? 'All Subjects' : (state.subjects[state.currentSubjectId]?.name || '');
        const uName = state.currentUnitId==='__all__' ? 'All Units' : (findCurrentUnit()?.name || '');
        els.keyHeader.textContent = `${sName} • ${uName} • ${state.total} Qs`;
        els.keyList.innerHTML = '';
        state.pool.forEach((q, idx) => {
          const wrap = document.createElement('div'); wrap.className = 'qitem';
          const h = document.createElement('h4'); h.textContent = `${idx+1}. ${q.text}`; wrap.appendChild(h);
          const ol = document.createElement('ol'); ol.className = 'opts';
          q.options.forEach((opt, j) => {
            const li = document.createElement('li'); li.textContent = opt;
            if (j === q.correctIndex) li.classList.add('correct');
            ol.appendChild(li);
          });
          wrap.appendChild(ol);
          const trick = document.createElement('div'); trick.className='trick'; trick.textContent='Trick: ' + (q.trick || '—'); wrap.appendChild(trick);
          els.keyList.appendChild(wrap);
        });
        show('key');
      }
      function printKey() {
        const win = window.open('', '_blank'); if (!win) return;
        win.document.write('<!doctype html><title>Answer Key</title>');
        win.document.write('<style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:16px;} ol{padding-left:22px;} li{margin:6px 0;padding:6px;border:1px solid #ddd;border-radius:6px;} li.correct{background:#ecfdf5;border-color:#86efac;} .q{margin:0 0 8px 0;font-weight:600;}</style>');
        state.pool.forEach((q, idx) => {
          win.document.write(`<div><div class="q">${idx+1}. ${q.text}</div><ol>`);
          q.options.forEach((opt, j) => {
            const cls = (j===q.correctIndex) ? 'class="correct"' : '';
            win.document.write(`<li ${cls}>${opt}</li>`);
          });
          win.document.write(`</ol></div>`);
        });
        win.document.close(); win.focus(); win.print();
      }

      // Quiz
      function findCurrentUnit() {
        const sub = state.subjects[state.currentSubjectId]; if (!sub) return null;
        return sub.units.find(u => u.id === state.currentUnitId);
      }
      function renderQuestion() {
        const q = state.pool[state.index]; if (!q) return;
        els.qText.textContent = `${state.index+1}. ${q.text}`;
        els.qOpts.innerHTML=''; q.options.forEach((opt,j)=>{ const li=document.createElement('li'); li.textContent=opt; li.dataset.idx=j; li.addEventListener('click',()=>handleChoice(j)); els.qOpts.appendChild(li); });
        const chosen = state.answered.get(state.index); if (typeof chosen==='number') applyMarking(chosen, q.correctIndex);
        const sName = state.currentSubjectId==='__all__' ? 'All Subjects' : (state.subjects[state.currentSubjectId]?.name || '');
        const uName = state.currentUnitId==='__all__' ? 'All Units' : (findCurrentUnit()?.name || '');
        els.subjectBadge.textContent = sName; els.unitBadge.textContent = uName;
        els.qCounter.textContent = `Q ${state.index+1}/${state.total}`;
        const pct = state.total ? Math.round(((state.index+1)/state.total)*100) : 0; els.progressBar.style.width=pct+'%';
        if (state.mode==='practice') { els.qTrick.style.display='block'; els.qTrick.textContent='Trick: ' + (q.trick || '—'); }
        else { const reveal=(typeof chosen==='number'); els.qTrick.style.display=reveal?'block':'none'; els.qTrick.textContent=reveal?('Trick: ' + (q.trick || '—')):''; }
        els.prevBtn.disabled = state.index===0; els.nextBtn.disabled = state.index>=state.total-1; els.endBtn.style.display=(state.mode==='test')?'inline-block':'none';
      }
      function applyMarking(chosenIdx, correctIdx) {
        const items = els.qOpts.querySelectorAll('li'); items.forEach((li,j)=>{ li.classList.remove('correct','wrong'); if (j===correctIdx) li.classList.add('correct'); if (j===chosenIdx && j!==correctIdx) li.classList.add('wrong'); });
      }
      function handleChoice(j) {
        const q=state.pool[state.index]; if (!q) return;
        const already = state.answered.get(state.index); if (state.mode==='test' && typeof already==='number') return;
        state.answered.set(state.index, j); applyMarking(j, q.correctIndex);
        if (state.mode==='test') { if (j===q.correctIndex) state.score++; els.qTrick.style.display='block'; els.qTrick.textContent='Trick: ' + (q.trick || '—'); }
      }
      function startQuiz() {
        state.view='quiz'; state.mode=els.modeSelect.value;
        state.settings.count = els.countInput.value || null;
        state.settings.shuffleQuestions = els.shuffleQuestions.checked;
        state.settings.shuffleOptions = els.shuffleOptions.checked;
        buildBasePool(); applySettingsAndPreparePool(); show('quiz'); renderQuestion(); window.scrollTo({top:0,behavior:'smooth'});
      }
      function endTest() { show('result'); const pct = state.total ? Math.round((state.score/state.total)*100) : 0; els.scoreLine.textContent = `Score: ${state.score} / ${state.total} (${pct}%)`; }
      function nextQ(){ if (state.index<state.total-1){ state.index++; renderQuestion(); } }
      function prevQ(){ if (state.index>0){ state.index--; renderQuestion(); } }

      // Events for UX
      function onSubjectChange() {
        state.currentSubjectId = els.subjectSelect.value; populateUnitSelect(); renderSidebarUnits();
        if (state.view==='answers') { onUnitChange(); } // auto show key
      }
      function onUnitChange() {
        state.currentUnitId = els.unitSelect.value;
        if (state.view==='answers') { buildAnswerKey(); }
      }
      function onViewChange() {
        state.view = els.viewSelect.value;
        els.startBtn.style.display = (state.view==='quiz') ? 'inline-block' : 'none';
        els.quizModeWrap.style.display = (state.view==='quiz') ? 'flex' : 'none';
        if (state.view==='answers') { buildAnswerKey(); }
        else { show('quiz'); } // wait for Start Quiz
      }
      function onSettingsChange() {
        state.settings.shuffleQuestions = els.shuffleQuestions.checked;
        state.settings.shuffleOptions = els.shuffleOptions.checked;
        // Rebuild key immediately if in key view
        if (state.view==='answers') buildAnswerKey();
      }

      // Wire UI
      els.subjectSelect.addEventListener('change', onSubjectChange);
      els.unitSelect.addEventListener('change', onUnitChange);
      els.viewSelect.addEventListener('change', onViewChange);
      els.shuffleQuestions.addEventListener('change', onSettingsChange);
      els.shuffleOptions.addEventListener('change', onSettingsChange);
      els.countInput.addEventListener('input', ()=>{ if (state.view==='answers') buildAnswerKey(); });
      els.printKeyBtn.addEventListener('click', printKey);

      els.startBtn.addEventListener('click', startQuiz);
      els.prevBtn.addEventListener('click', prevQ);
      els.nextBtn.addEventListener('click', nextQ);
      els.endBtn.addEventListener('click', endTest);
      els.restartBtn.addEventListener('click', startQuiz);

      // Subject registrations
      document.addEventListener('subject-registered', () => {
        state.subjects = window.quizSubjects || {};
        state.subjectOrder = Object.values(state.subjects).sort((a,b)=>a.name.localeCompare(b.name)).map(s=>s.id);
        populateSubjectSelect(); updateSummary();
        // Auto select first subject if none chosen and show key
        if (state.currentSubjectId==='__all__' && state.subjectOrder.length) {
          els.subjectSelect.value = state.subjectOrder[0]; onSubjectChange();
        }
      });

      document.addEventListener('DOMContentLoaded', () => {
        autoRegisterFromQuizData();
        // If subjects already there, init UI
        state.subjects = window.quizSubjects || {};
        state.subjectOrder = Object.values(state.subjects).sort((a,b)=>a.name.localeCompare(b.name)).map(s=>s.id);
        populateSubjectSelect(); updateSummary();
        els.viewSelect.value = 'answers'; onViewChange(); // default Answer Key
      });

      setTimeout(() => {
        if (!Object.keys(window.quizSubjects||{}).length) autoRegisterFromQuizData();
        state.subjects = window.quizSubjects || {};
        state.subjectOrder = Object.values(state.subjects).sort((a,b)=>a.name.localeCompare(b.name)).map(s=>s.id);
        populateSubjectSelect(); updateSummary();
      }, 400);
    })();
  </script>
</body>
</html>
