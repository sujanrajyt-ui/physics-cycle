<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>UHV Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --accent:#2563eb; --accent-2:#1d4ed8; --ok:#059669; --bad:#dc2626; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text);}
    .container{max-width:1100px; margin:24px auto; padding:0 16px;}
    header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px;}
    .brand{display:flex;align-items:center;gap:10px;}
    .badge{background:#eef2ff;color:#1e293b;border:1px solid #c7d2fe;border-radius:999px;padding:4px 10px;font-size:12px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;}
    .controls{display:grid;grid-template-columns:1fr 1fr auto; gap:10px; align-items:end;}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px;}
    select,button{border:1px solid var(--border);border-radius:8px;padding:10px 12px;font-size:14px;}
    button{background:var(--accent);color:white;border-color:var(--accent-2);cursor:pointer;}
    button.secondary{background:#f1f5f9;color:#0f172a;border-color:var(--border);}
    button:disabled{opacity:.6;cursor:not-allowed}
    .panel{margin-top:14px; display:none;}
    .panel.active{display:block;}
    .meta{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;margin-bottom:10px;}
    .muted{color:var(--muted); font-size:13px;}
    .qbox{padding:12px;border:1px dashed var(--border);border-radius:10px;margin-bottom:10px;background:#fcfcff;}
    .qtext{font-weight:600;margin-bottom:8px;}
    ol.opts{margin:0; padding-left:22px;}
    ol.opts li{margin:6px 0; padding:8px 10px;border:1px solid var(--border);border-radius:8px;cursor:pointer;background:#fff;}
    ol.opts li:hover{border-color:#cbd5e1; background:#f8fafc;}
    ol.opts li.correct{border-color:#86efac;background:#ecfdf5;}
    ol.opts li.wrong{border-color:#fecaca;background:#fef2f2;}
    .trick{font-size:13px;color:#0f172a;background:#f8fafc;border:1px solid var(--border);border-radius:8px;padding:8px;margin-top:10px;}
    .nav{display:flex;gap:8px;justify-content:space-between;margin-top:12px;}
    .progress{height:8px;background:#e2e8f0;border-radius:6px;overflow:hidden;margin:8px 0 0;}
    .bar{height:100%;background:var(--accent);width:0%;}
    .grid{display:grid;grid-template-columns:280px 1fr; gap:12px;align-items:start;}
    .sidebar{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;max-height:70vh;overflow:auto;}
    .unit{padding:8px;border-radius:8px;cursor:pointer;}
    .unit:hover{background:#f8fafc;}
    .unit.active{background:#eef2ff;border:1px solid #c7d2fe;}
    .small{font-size:12px;color:var(--muted);}
    .result{display:grid;gap:8px;}
    .score{font-size:20px;font-weight:700;}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <h2 style="margin:0;">UHV Quiz</h2>
        <span class="badge" id="summaryBadge">Loading…</span>
      </div>
      <div class="muted" id="comingNote">If you see “Coming soon” elsewhere, this page will still render the quiz.</div>
    </header>

    <div class="card">
      <div class="controls">
        <div>
          <label for="unitSelect">Unit</label>
          <select id="unitSelect">
            <option value="__all__">All Units</option>
          </select>
        </div>
        <div>
          <label for="modeSelect">Mode</label>
          <select id="modeSelect">
            <option value="practice">Practice (infinite, instant feedback)</option>
            <option value="test">Test (20 questions, score)</option>
          </select>
        </div>
        <div>
          <button id="startBtn">Start</button>
        </div>
      </div>

      <div class="panel" id="quizPanel">
        <div class="meta">
          <div>
            <span class="badge" id="unitBadge">Unit</span>
            <span class="muted" id="qCounter">Q 0/0</span>
          </div>
          <div style="min-width:140px;">
            <div class="progress"><div class="bar" id="progressBar"></div></div>
          </div>
        </div>

        <div class="qbox">
          <div class="qtext" id="qText">Question text</div>
          <ol class="opts" id="qOpts"></ol>
          <div class="trick" id="qTrick" style="display:none;"></div>
        </div>

        <div class="nav">
          <div>
            <button class="secondary" id="prevBtn">Prev</button>
            <button class="secondary" id="nextBtn">Next</button>
          </div>
          <div>
            <button class="secondary" id="endBtn" style="display:none;">End Test</button>
          </div>
        </div>
      </div>

      <div class="panel" id="resultPanel">
        <div class="result">
          <div class="score" id="scoreLine">Score: 0/0</div>
          <div class="muted" id="resultNote">Well done. You can restart with different settings.</div>
          <div>
            <button id="restartBtn">Restart</button>
          </div>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:12px;">
      <div class="sidebar" id="unitList"></div>
      <div class="card">
        <div class="muted">Tip: Click a unit on the left to preview its question count. Quiz content is driven by uhv-data.bundle.js.</div>
      </div>
    </div>
  </div>

  <!-- Load dataset FIRST -->
  <script src="uhv-data.bundle.js" defer></script>

  <!-- App logic -->
  <script>
    (function () {
      const els = {
        unitSelect: document.getElementById('unitSelect'),
        modeSelect: document.getElementById('modeSelect'),
        startBtn: document.getElementById('startBtn'),
        quizPanel: document.getElementById('quizPanel'),
        resultPanel: document.getElementById('resultPanel'),
        qText: document.getElementById('qText'),
        qOpts: document.getElementById('qOpts'),
        qTrick: document.getElementById('qTrick'),
        qCounter: document.getElementById('qCounter'),
        progressBar: document.getElementById('progressBar'),
        unitBadge: document.getElementById('unitBadge'),
        summaryBadge: document.getElementById('summaryBadge'),
        comingNote: document.getElementById('comingNote'),
        prevBtn: document.getElementById('prevBtn'),
        nextBtn: document.getElementById('nextBtn'),
        endBtn: document.getElementById('endBtn'),
        resultNote: document.getElementById('resultNote'),
        scoreLine: document.getElementById('scoreLine'),
        restartBtn: document.getElementById('restartBtn'),
        unitList: document.getElementById('unitList')
      };

      const state = {
        ready: false,
        units: [],
        currentUnitName: '__all__',
        pool: [],
        index: 0,
        answered: new Map(), // key: index -> chosenIdx
        mode: 'practice',
        score: 0,
        total: 0
      };

      function getUnitsFromData() {
        const qd = window.quizData || {};
        const raw = qd.UHV || {};
        const units = Object.entries(raw).map(([name, questions]) => ({ name, questions }));
        return units;
      }

      function updateSummary() {
        const units = state.units;
        const total = units.reduce((n,u)=>n+(u.questions?.length||0),0);
        els.summaryBadge.textContent = `${units.length} units • ${total} questions`;
        // Sidebar
        els.unitList.innerHTML = '';
        units.forEach((u, i) => {
          const div = document.createElement('div');
          div.className = 'unit' + (i===0 ? ' active':'');
          div.textContent = u.name;
          const small = document.createElement('div');
          small.className = 'small';
          small.textContent = `${u.questions.length} questions`;
          div.appendChild(small);
          div.addEventListener('click', () => {
            els.unitList.querySelectorAll('.unit').forEach(n => n.classList.remove('active'));
            div.classList.add('active');
            // also reflect in select
            els.unitSelect.value = u.name;
          });
          els.unitList.appendChild(div);
        });
      }

      function populateUnitSelect() {
        const sel = els.unitSelect;
        sel.innerHTML = '<option value="__all__">All Units</option>';
        state.units.forEach(u => {
          const opt = document.createElement('option');
          opt.value = u.name;
          opt.textContent = u.name;
          sel.appendChild(opt);
        });
      }

      function buildPool() {
        const unitName = state.currentUnitName;
        if (unitName === '__all__') {
          state.pool = state.units.flatMap(u => u.questions || []);
          state.unitForIndex = null; // not tracked per-q in practice; we can omit
        } else {
          const unit = state.units.find(u => u.name === unitName);
          state.pool = [...(unit?.questions || [])];
        }
        state.total = state.pool.length;
        state.index = 0;
        state.answered.clear();
        state.score = 0;
      }

      function showPanel(which) {
        els.quizPanel.classList.toggle('active', which === 'quiz');
        els.resultPanel.classList.toggle('active', which === 'result');
      }

      function renderQuestion() {
        const q = state.pool[state.index];
        if (!q) return;
        els.qText.textContent = `${state.index+1}. ${q.text}`;
        els.qOpts.innerHTML = '';
        q.options.forEach((opt, j) => {
          const li = document.createElement('li');
          li.textContent = opt;
          li.setAttribute('data-idx', j);
          li.addEventListener('click', () => handleChoice(j));
          els.qOpts.appendChild(li);
        });

        const chosen = state.answered.get(state.index);
        if (typeof chosen === 'number') applyMarking(chosen, q.correctIndex);

        // Meta
        els.qCounter.textContent = `Q ${state.index+1}/${state.total}`;
        els.unitBadge.textContent = state.currentUnitName === '__all__' ? 'All Units' : state.currentUnitName;
        const pct = state.total ? Math.round(((state.index+1)/state.total)*100) : 0;
        els.progressBar.style.width = pct + '%';

        // Hide trick until answered (practice) or always show in practice?
        if (state.mode === 'practice') {
          els.qTrick.style.display = 'block';
          els.qTrick.textContent = 'Trick: ' + (q.trick || '—');
        } else {
          // test mode → only reveal after answering
          const reveal = typeof chosen === 'number';
          els.qTrick.style.display = reveal ? 'block' : 'none';
          els.qTrick.textContent = reveal ? ('Trick: ' + (q.trick || '—')) : '';
        }

        // Nav buttons
        els.prevBtn.disabled = state.index === 0;
        els.nextBtn.disabled = state.index >= state.total - 1;
        els.endBtn.style.display = (state.mode === 'test') ? 'inline-block' : 'none';
      }

      function applyMarking(chosenIdx, correctIdx) {
        const items = els.qOpts.querySelectorAll('li');
        items.forEach((li, j) => {
          li.classList.remove('correct','wrong');
          if (j === correctIdx) li.classList.add('correct');
          if (j === chosenIdx && j !== correctIdx) li.classList.add('wrong');
        });
      }

      function handleChoice(j) {
        const q = state.pool[state.index];
        if (!q) return;
        const already = state.answered.get(state.index);
        // In test mode, lock once chosen
        if (state.mode === 'test' && typeof already === 'number') return;

        state.answered.set(state.index, j);
        applyMarking(j, q.correctIndex);
        if (state.mode === 'test') {
          if (j === q.correctIndex) state.score++;
          els.qTrick.style.display = 'block';
          els.qTrick.textContent = 'Trick: ' + (q.trick || '—');
        }
      }

      function nextQ() {
        if (state.index < state.total - 1) {
          state.index++;
          renderQuestion();
        }
      }
      function prevQ() {
        if (state.index > 0) {
          state.index--;
          renderQuestion();
        }
      }

      function endTest() {
        showPanel('result');
        els.scoreLine.textContent = `Score: ${state.score} / ${state.total} (${Math.round((state.score/state.total)*100)}%)`;
        els.resultNote.textContent = 'Review your performance or restart with different settings.';
      }

      function start() {
        state.currentUnitName = els.unitSelect.value;
        state.mode = els.modeSelect.value;
        buildPool();
        if (state.mode === 'test') {
          // pick 20 or less random
          const N = Math.min(20, state.pool.length);
          // simple shuffle copy
          const shuffled = state.pool.map((x,i)=>({x, r:Math.random()})).sort((a,b)=>a.r-b.r).map(o=>o.x);
          state.pool = shuffled.slice(0,N);
          state.total = state.pool.length;
        }
        showPanel('quiz');
        renderQuestion();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function restart() {
        showPanel('quiz');
        start();
      }

      function onDataReady() {
        state.units = getUnitsFromData();
        if (!state.units.length) {
          els.summaryBadge.textContent = 'No data found';
          return;
        }
        state.ready = true;
        populateUnitSelect();
        updateSummary();
      }

      // Wire handlers
      els.startBtn.addEventListener('click', start);
      els.prevBtn.addEventListener('click', prevQ);
      els.nextBtn.addEventListener('click', nextQ);
      els.endBtn.addEventListener('click', endTest);
      els.restartBtn.addEventListener('click', restart);

      // Handle dataset readiness
      document.addEventListener('quiz-data-ready', onDataReady, { once: true });
      // Also attempt after DOM ready (in case event fired earlier)
      document.addEventListener('DOMContentLoaded', () => {
        const qd = window.quizData;
        if (qd?.UHV && !state.ready) onDataReady();
      });

      // Safety timeout to handle cases where defer order differs
      setTimeout(() => {
        const qd = window.quizData;
        if (qd?.UHV && !state.ready) onDataReady();
      }, 400);

    })();
  </script>
</body>
</html>
