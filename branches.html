<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const SUPABASE_URL = 'https://brvbbxbfcrcpgkxxfuhv.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJydmJieGJmY3JjcGdreHhmdWh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NzM1MzIsImV4cCI6MjA4MDE0OTUzMn0.Z8FYzhVSn0eMgQAWcXg9ul70AeSyWMid4dFtrhAZalQ';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI Refs
    const unitSection = document.getElementById('unitSection');
    const unitButtonsEl = document.getElementById('unitButtons');
    const notesSection = document.getElementById('notesSection');
    const notesContent = document.getElementById('notesContent');
    const statusMessage = document.getElementById('statusMessage');
    const crumb = document.getElementById('crumb');
    const locationCrumb = document.getElementById('locationCrumb');
    const openFolderLink = document.getElementById('openFolderLink');

    let state = { subject: null, unit: null };

    // --- HELPER FUNCTIONS ---

    function showLoading(msg) {
      statusMessage.className = 'message';
      statusMessage.textContent = msg;
      statusMessage.classList.remove('hidden');
    }
    
    function showError(msg) {
      statusMessage.className = 'message message-error';
      statusMessage.textContent = msg;
      statusMessage.classList.remove('hidden');
    }
    
    function hideStatus() {
      statusMessage.classList.add('hidden');
    }

    function setActive(container, selector) {
      container.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
      if(selector) container.querySelector(selector)?.classList.add('active');
    }

    // ROBUST CHECKS: In Supabase storage .list(), files have an 'id', folders usually don't.
    const isFolder = (item) => !item.id; 
    const isFile = (item) => !!item.id;

    // --- CORE LOGIC ---

    async function onSubjectClick(subject) {
      state.subject = subject;
      state.unit = null;

      // 1. Construct path: semester1/SubjectName
      // Note: Basic Electronics needs the space if that's how it is in bucket
      const folderPath = `semester1/${subject}`; 

      setActive(document.getElementById('subjectButtons'), `.btn[data-subject="${subject}"]`);
      
      // Reset UI
      unitSection.classList.add('hidden');
      notesSection.classList.add('hidden');
      showLoading(`Scanning ${folderPath}...`);

      console.log(`[DEBUG] Listing folder: "${folderPath}"`);

      // 2. Fetch List
      const { data, error } = await supabase.storage.from('notes').list(folderPath, {
        limit: 100,
        sortBy: { column: 'name', order: 'asc' }
      });

      if (error) {
        console.error('[DEBUG] API Error:', error);
        showError('Error connecting to database.');
        return;
      }

      console.log('[DEBUG] Response Data:', data);

      if (!data || data.length === 0) {
        showError(`Folder "${folderPath}" appears empty.`);
        return;
      }

      hideStatus();

      // 3. Separate Folders (Units) and Files
      // Some users might use .placeholder files to create folders, we filter those out if needed
      const folders = data.filter(item => isFolder(item) && item.name !== '.emptyFolderPlaceholder');
      const files = data.filter(isFile);

      console.log(`[DEBUG] Found ${folders.length} folders (Units) and ${files.length} files.`);

      // 4. Show Unit Buttons (if folders exist)
      if (folders.length > 0) {
        crumb.textContent = subject;
        unitButtonsEl.innerHTML = '';
        
        folders.forEach(f => {
          const b = document.createElement('button');
          b.className = 'btn';
          // Display Name: Remove sorting numbers like "01_"
          b.textContent = f.name.replace(/^\d+[_-]/, ''); 
          // Data Unit: Keep exact folder name
          b.dataset.unit = f.name; 
          b.addEventListener('click', () => onUnitClick(f.name, folderPath));
          unitButtonsEl.appendChild(b);
        });
        unitSection.classList.remove('hidden');
      }

      // 5. Show Files (if they exist at root)
      if (files.length > 0) {
        renderFileList(files, folderPath, `${subject} (General Files)`);
      } else if (folders.length === 0) {
        showError('No units or files found in this subject folder.');
      }
    }

    async function onUnitClick(unitName, parentPath) {
      // Path: semester1/Subject/UnitName
      const unitPath = `${parentPath}/${unitName}`;
      
      setActive(unitButtonsEl, `.btn[data-unit="${unitName}"]`);
      showLoading(`Loading ${unitName}...`);
      
      console.log(`[DEBUG] Listing unit: "${unitPath}"`);

      const { data, error } = await supabase.storage.from('notes').list(unitPath, {
        limit: 100,
        sortBy: { column: 'name', order: 'asc' }
      });

      if (error) {
        console.error('[DEBUG] Unit Error:', error);
        showError('Failed to load unit.');
        return;
      }

      hideStatus();

      const files = data.filter(isFile);
      
      if (files.length === 0) {
        showError(`No files found inside ${unitName}.`);
        notesSection.classList.add('hidden');
      } else {
        renderFileList(files, unitPath, `${state.subject} â€¢ ${unitName.replace(/^\d+[_-]/, '')}`);
      }
    }

    function renderFileList(files, folderPath, title) {
      notesSection.classList.remove('hidden');
      locationCrumb.textContent = title;

      const listHtml = files.map(f => {
        const { data } = supabase.storage.from('notes').getPublicUrl(`${folderPath}/${f.name}`);
        // Clean up name: remove "01_" prefix and ".pdf" extension
        const displayName = f.name.replace(/^\d+[_-]/, '').replace(/\.[^/.]+$/, ""); 
        
        return `<li><a class="subject-pill" href="${data.publicUrl}" target="_blank">${displayName}</a></li>`;
      }).join('');

      notesContent.innerHTML = `<ul class="subjects-list">${listHtml}</ul>`;

      // Folder Link
      const { data: folderData } = supabase.storage.from('notes').getPublicUrl(folderPath);
      openFolderLink.href = folderData.publicUrl;
      openFolderLink.classList.remove('hidden');
    }

    // Attach listeners to static Subject buttons
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.subject-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          // Pass exact text from data-subject attribute
          onSubjectClick(btn.dataset.subject);
        });
      });
    });
</script>
