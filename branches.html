<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Physics Cycle - Semester 1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <!-- 1. Load Supabase Global Script (No Module needed) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    /* Basic Resets */
    .hidden { display: none !important; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #f8fafc; margin: 0; color: #0f172a; }
    
    /* Layout */
    .container { max-width: 1100px; margin: 20px auto; padding: 0 15px; }
    .card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    
    /* Buttons */
    .btn-grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
    .btn {
      display: flex; align-items: center; justify-content: center;
      padding: 15px; font-size: 1rem; font-weight: 600;
      background: #2563eb; color: white; border: 1px solid #1d4ed8; border-radius: 10px;
      cursor: pointer; transition: all 0.2s; text-align: center;
    }
    .btn:hover { background: #1d4ed8; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn.active { background: #1e3a8a; border-color: #172554; ring: 2px solid #93c5fd; }

    /* Status Box */
    .status-box { padding: 15px; border-radius: 8px; margin-bottom: 15px; font-weight: 500; }
    .status-loading { background: #eff6ff; color: #1e40af; border: 1px solid #dbeafe; }
    .status-error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
    .status-empty { background: #fffbeb; color: #92400e; border: 1px solid #fde68a; }

    /* List Items */
    .file-list { list-style: none; padding: 0; }
    .file-list li { margin-bottom: 10px; }
    .file-link {
      display: block; padding: 12px; background: #fff; border: 1px solid #cbd5e1; 
      border-radius: 8px; text-decoration: none; color: #2563eb; font-weight: 500;
    }
    .file-link:hover { background: #f1f5f9; border-color: #94a3b8; }

    /* Navigation */
    .nav-links { display: flex; gap: 15px; margin-bottom: 20px; }
    .nav-link { text-decoration: none; color: #64748b; font-weight: bold; }
    .nav-link.active { color: #2563eb; }
  </style>
</head>
<body>

  <div class="container">
    <!-- Header -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h1 style="margin:0;">Physics Cycle</h1>
      <nav class="nav-links">
        <a href="index.html" class="nav-link">Home</a>
        <a href="branches.html" class="nav-link active">Notes</a>
        <a href="quiz.html" class="nav-link">Quiz</a>
      </nav>
    </div>

    <!-- 1. Subject Selection -->
    <div class="card">
      <h2 style="margin-top:0;">Select Subject</h2>
      <div class="btn-grid" id="subjectButtons">
        <!-- Folders must match exactly what is in Supabase -->
        <button class="btn" onclick="selectSubject('PSP')">PSP</button>
        <button class="btn" onclick="selectSubject('Physics')">Physics</button>
        <button class="btn" onclick="selectSubject('Calculus')">Calculus</button>
        <button class="btn" onclick="selectSubject('Basic Electronics')">Basic Electronics</button>
        <button class="btn" onclick="selectSubject('ADLD')">ADLD</button>
        <button class="btn" onclick="selectSubject('UHV')">UHV</button>
        <button class="btn" onclick="selectSubject('COI')">COI</button>
      </div>
    </div>

    <!-- Status Message Area -->
    <div id="statusArea" class="hidden"></div>

    <!-- 2. Unit Selection (Hidden by default) -->
    <div id="unitCard" class="card hidden">
      <h2 style="margin-top:0;">Select Unit</h2>
      <div class="btn-grid" id="unitButtons"></div>
    </div>

    <!-- 3. File List (Hidden by default) -->
    <div id="fileCard" class="card hidden">
      <h2 style="margin-top:0;">Notes</h2>
      <ul id="fileList" class="file-list"></ul>
      <a id="openFolderBtn" href="#" target="_blank" style="display:inline-block; margin-top:10px; color:#64748b; font-size:0.9rem;">Open Full Folder</a>
    </div>
  </div>

  <script>
    // --- 1. INITIALIZE SUPABASE (Standard JS way) ---
    // This check ensures the script loaded
    if (typeof supabase === 'undefined') {
      alert("Error: Supabase script failed to load. Check your internet connection.");
    }

    const SUPABASE_URL = 'https://brvbbxbfcrcpgkxxfuhv.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJydmJieGJmY3JjcGdreHhmdWh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NzM1MzIsImV4cCI6MjA4MDE0OTUzMn0.Z8FYzhVSn0eMgQAWcXg9ul70AeSyWMid4dFtrhAZalQ';
    
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- STATE ---
    let currentSubject = "";

    // --- UI HELPERS ---
    function showStatus(msg, type) {
      const el = document.getElementById('statusArea');
      el.className = `status-box status-${type}`;
      el.textContent = msg;
      el.classList.remove('hidden');
    }
    function hideStatus() {
      document.getElementById('statusArea').classList.add('hidden');
    }
    function highlightSubject(name) {
      document.querySelectorAll('#subjectButtons .btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.innerText === name) btn.classList.add('active');
      });
    }

    // --- MAIN FUNCTIONS ---

    // 1. Called when Subject Button is clicked
    async function selectSubject(subjectName) {
      console.log("Clicked:", subjectName); // Debug log
      currentSubject = subjectName;
      
      // Reset UI
      highlightSubject(subjectName);
      document.getElementById('unitCard').classList.add('hidden');
      document.getElementById('fileCard').classList.add('hidden');
      showStatus(`Scanning notes for ${subjectName}...`, 'loading');

      const folderPath = `semester1/${subjectName}`;

      // LIST FOLDER
      const { data, error } = await sb.storage.from('notes').list(folderPath, {
        limit: 100,
        sortBy: { column: 'name', order: 'asc' }
      });

      if (error) {
        console.error(error);
        showStatus(`Error: ${error.message}`, 'error');
        return;
      }

      if (!data || data.length === 0) {
        showStatus(`No notes found for ${subjectName} (Folder empty or name mismatch).`, 'empty');
        return;
      }

      hideStatus();

      // Separate files vs folders
      // In Supabase, folders usually have NO 'id'. Files HAVE 'id'.
      const units = data.filter(item => !item.id); 
      const files = data.filter(item => item.id);

      // A. If subfolders (Units) exist, show Unit buttons
      if (units.length > 0) {
        const unitContainer = document.getElementById('unitButtons');
        unitContainer.innerHTML = '';
        
        units.forEach(unit => {
          const btn = document.createElement('button');
          btn.className = 'btn';
          // Clean Name: "01_Unit 1" -> "Unit 1"
          btn.innerText = unit.name.replace(/^\d+[_-]/, ''); 
          btn.onclick = () => selectUnit(folderPath, unit.name);
          unitContainer.appendChild(btn);
        });
        document.getElementById('unitCard').classList.remove('hidden');
      } 
      
      // B. If files exist at root, show them directly
      if (files.length > 0) {
        renderFiles(files, folderPath);
      } else if (units.length === 0) {
        showStatus("Folder exists but appears empty.", 'empty');
      }
    }

    // 2. Called when Unit Button is clicked
    async function selectUnit(parentPath, unitName) {
      const fullPath = `${parentPath}/${unitName}`;
      
      // Highlight unit button
      document.querySelectorAll('#unitButtons .btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');

      showStatus(`Loading ${unitName}...`, 'loading');
      document.getElementById('fileCard').classList.add('hidden');

      const { data, error } = await sb.storage.from('notes').list(fullPath, {
        limit: 100,
        sortBy: { column: 'name', order: 'asc' }
      });

      if (error) {
        showStatus(`Error: ${error.message}`, 'error');
        return;
      }

      hideStatus();
      const files = data.filter(item => item.id); // Only files

      if (files.length === 0) {
        showStatus(`No files found in ${unitName}.`, 'empty');
      } else {
        renderFiles(files, fullPath);
      }
    }

    // 3. Render File List
    function renderFiles(files, folderPath) {
      const list = document.getElementById('fileList');
      list.innerHTML = '';

      files.forEach(file => {
        // Get Public URL
        const { data } = sb.storage.from('notes').getPublicUrl(`${folderPath}/${file.name}`);
        
        // Create Link
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.className = 'file-link';
        a.href = data.publicUrl;
        a.target = '_blank';
        // Clean name: "01_Notes.pdf" -> "Notes"
        a.innerText = file.name.replace(/^\d+[_-]/, '').replace(/\.[^/.]+$/, "");
        
        li.appendChild(a);
        list.appendChild(li);
      });

      // Set "Open Folder" link
      const folderUrl = sb.storage.from('notes').getPublicUrl(folderPath);
      document.getElementById('openFolderBtn').href = folderUrl.data.publicUrl;

      document.getElementById('fileCard').classList.remove('hidden');
    }
  </script>
</body>
</html>
