<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Physics Cycle - Semester 1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    /* --- CSS STYLES --- */
    .hidden { display: none !important; }
    .btn-grid { display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
    .btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px; border: 1px solid #1d4ed8; border-radius: 10px; background: #2563eb; color: #fff; font-weight: 500; cursor: pointer; min-height: 46px; font-family: inherit; font-size: 1rem; }
    .btn:active, .btn.active { background: #1e3a8a; border-color: #1e3a8a; }
    
    /* Debug/Status Box */
    #statusBox { margin: 15px 0; padding: 15px; border-radius: 8px; background: #f1f5f9; border: 1px solid #cbd5e1; color: #334155; font-family: monospace; white-space: pre-wrap; }
    .error-text { color: #dc2626; font-weight: bold; }
    .success-text { color: #16a34a; font-weight: bold; }

    /* Breadcrumbs & Lists */
    .crumb { display: inline-flex; background: #eef2ff; color: #3730a3; padding: 4px 10px; border-radius: 99px; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; }
    .subjects-list { list-style: none; padding: 0; margin: 0; }
    .subjects-list li { margin-bottom: 8px; }
    .subject-pill { display: block; padding: 10px; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; color: #2563eb; text-decoration: none; transition: 0.2s; }
    .subject-pill:hover { border-color: #2563eb; background: #eff6ff; }

    /* Layout */
    .card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .card h2 { margin: 0 0 10px 0; font-size: 1.1rem; }
  </style>
</head>
<body>

  <header class="site-header">
    <div class="header-inner">
      <div class="logo">Physics Cycle</div>
      <nav class="nav-links">
        <a href="index.html" class="nav-link">Home</a>
        <a href="branches.html" class="nav-link active">Notes</a>
        <a href="quiz.html" class="nav-link">Quiz</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- SUBJECTS -->
    <section class="card">
      <h2>Select Subject</h2>
      <div id="subjectButtons" class="btn-grid">
        <!-- NOTE: These names MUST match your Supabase Folder names exactly -->
        <button class="btn subject-btn" data-folder="PSP">PSP</button>
        <button class="btn subject-btn" data-folder="Physics">Physics</button>
        <button class="btn subject-btn" data-folder="Calculus">Calculus</button>
        <button class="btn subject-btn" data-folder="Basic Electronics">Basic Electronics</button>
        <button class="btn subject-btn" data-folder="ADLD">ADLD</button>
        <button class="btn subject-btn" data-folder="UHV">UHV</button>
        <button class="btn subject-btn" data-folder="COI">COI</button>
      </div>
    </section>

    <!-- DIAGNOSTIC STATUS BOX -->
    <div id="statusBox" class="hidden"></div>

    <!-- UNITS -->
    <section id="unitSection" class="card hidden">
      <div class="crumb" id="unitCrumb">Subject</div>
      <h2>Select Unit</h2>
      <div id="unitButtons" class="btn-grid"></div>
    </section>

    <!-- FILES -->
    <section id="fileSection" class="card hidden">
      <div class="crumb" id="fileCrumb">Subject > Unit</div>
      <h2>Files</h2>
      <ul id="fileList" class="subjects-list"></ul>
      <div style="margin-top:10px;">
        <a id="openFolderLink" href="#" target="_blank" class="subject-pill" style="text-align:center;">Open Folder in Browser</a>
      </div>
    </section>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    // --- CONFIG ---
    const SUPABASE_URL = 'https://brvbbxbfcrcpgkxxfuhv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJydmJieGJmY3JjcGdreHhmdWh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NzM1MzIsImV4cCI6MjA4MDE0OTUzMn0.Z8FYzhVSn0eMgQAWcXg9ul70AeSyWMid4dFtrhAZalQ';
    const BUCKET_NAME = 'notes'; 
    const ROOT_FOLDER = 'semester1'; // Case sensitive!

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- ELEMENTS ---
    const statusBox = document.getElementById('statusBox');
    const unitSection = document.getElementById('unitSection');
    const unitButtons = document.getElementById('unitButtons');
    const fileSection = document.getElementById('fileSection');
    const fileList = document.getElementById('fileList');
    const unitCrumb = document.getElementById('unitCrumb');
    const fileCrumb = document.getElementById('fileCrumb');
    const openFolderLink = document.getElementById('openFolderLink');

    let currentSubject = '';

    // --- LOGGING ---
    function log(msg, type='info') {
      statusBox.classList.remove('hidden');
      const color = type === 'error' ? 'error-text' : (type === 'success' ? 'success-text' : '');
      statusBox.innerHTML = `<span class="${color}">${msg}</span>`;
      console.log(msg);
    }

    // --- CORE LOGIC ---

    // 1. Click Subject
    window.loadSubject = async (folderName) => {
      currentSubject = folderName;
      
      // Reset UI
      unitSection.classList.add('hidden');
      fileSection.classList.add('hidden');
      document.querySelectorAll('.subject-btn').forEach(b => b.classList.remove('active'));
      const btn = document.querySelector(`button[data-folder="${folderName}"]`);
      if(btn) btn.classList.add('active');

      const path = `${ROOT_FOLDER}/${folderName}`;
      log(`Scanning folder: ${path}...`);

      // LIST FOLDER
      const { data, error } = await supabase.storage.from(BUCKET_NAME).list(path, {
        limit: 100,
        sortBy: { column: 'name', order: 'asc' }
      });

      // ERROR HANDLING
      if (error) {
        log(`Error accessing Supabase: ${error.message}`, 'error');
        return;
      }

      // EMPTY HANDLING
      if (!data || data.length === 0) {
        log(`Folder found but EMPTY: ${path}\n\nPossible reasons:\n1. Folder name case mismatch (e.g. "psp" vs "PSP")\n2. RLS Policies blocking 'SELECT' for public.\n3. Folder truly empty.`, 'error');
        return;
      }

      // SUCCESS
      const folders = data.filter(x => !x.id); // Items without ID are folders
      const files = data.filter(x => !!x.id && x.name !== '.emptyFolderPlaceholder');

      log(`Found: ${folders.length} Units (Folders) and ${files.length} Files.`, 'success');

      // If we have folders (Units), show Unit buttons
      if (folders.length > 0) {
        unitCrumb.textContent = folderName;
        unitButtons.innerHTML = '';
        folders.forEach(folder => {
          const b = document.createElement('button');
          b.className = 'btn';
          b.textContent = folder.name.replace(/^\d+[_-]/, ''); // Clean name
          b.onclick = () => loadUnit(folderName, folder.name);
          unitButtons.appendChild(b);
        });
        unitSection.classList.remove('hidden');
      } 
      
      // If we have files directly at root, show them
      if (files.length > 0) {
        showFiles(files, path, folderName + " (General)");
      } else if (folders.length === 0) {
        log("Folder exists but contains no visible files or subfolders.", 'error');
      }
    };

    // 2. Click Unit
    window.loadUnit = async (subject, unitName) => {
      const path = `${ROOT_FOLDER}/${subject}/${unitName}`;
      log(`Loading Unit: ${path}...`);

      const { data, error } = await supabase.storage.from(BUCKET_NAME).list(path);

      if (error) {
        log(`Error loading unit: ${error.message}`, 'error');
        return;
      }

      const files = data.filter(x => !!x.id && x.name !== '.emptyFolderPlaceholder');

      if (files.length === 0) {
        log(`Unit folder "${unitName}" exists but has no files.`, 'error');
        fileSection.classList.add('hidden');
      } else {
        log(`Loaded ${files.length} notes.`, 'success');
        showFiles(files, path, `${subject} > ${unitName}`);
      }
    };

    // 3. Render Files
    function showFiles(files, fullPath, title) {
      fileSection.classList.remove('hidden');
      fileCrumb.textContent = title;
      fileList.innerHTML = '';

      files.forEach(file => {
        // Get Public URL
        const { data } = supabase.storage.from(BUCKET_NAME).getPublicUrl(`${fullPath}/${file.name}`);
        
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.className = 'subject-pill';
        a.href = data.publicUrl;
        a.target = '_blank';
        // Clean name
        a.textContent = file.name.replace(/^\d+[_-]/, '').replace(/\.[^/.]+$/, ""); 
        
        li.appendChild(a);
        fileList.appendChild(li);
      });

      // Set "Open Folder" link
      const folderData = supabase.storage.from(BUCKET_NAME).getPublicUrl(fullPath);
      openFolderLink.href = folderData.data.publicUrl;
    }

    // Attach events
    document.querySelectorAll('.subject-btn').forEach(btn => {
      btn.addEventListener('click', () => loadSubject(btn.dataset.folder));
    });

  </script>
</body>
</html>
